<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smile Zone Health Panel</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        chat: {
                            bg: '#f0f9ff',
                            outgoing: '#e0f2fe',
                            incoming: '#ffffff',
                            bubble_shadow: '0 1px 0.5px rgba(12, 74, 110, .05)',
                        }
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background-color: #F8FAFC;
        }

        #root {
            height: 100%;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .stat-card { transition: all 0.2s ease-in-out; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .blur-content { filter: blur(5px); pointer-events: none; user-select: none; }

        .chat-bg-pattern {
            background-color: #f0f9ff;
            background-image: radial-gradient(#bae6fd 0.5px, transparent 0.5px), radial-gradient(#bae6fd 0.5px, #f0f9ff 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            opacity: 0.3;
        }
        
        .msg-tail-in {
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%, 0 0, 10px 0);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fillUp { 0% { height: 0%; } 100% { height: 100%; } }
        @keyframes dash { to { stroke-dashoffset: 0; } }
        @keyframes shimmer { 
            0% { transform: translateX(-100%); } 
            100% { transform: translateX(100%); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- CONFIGURATION ---
        const WEBHOOK_URL = "https://8ixs09rp.rpcld.app/webhook/leads-upload";
        const DELETE_WEBHOOK_URL = "https://8ixs09rp.rpcld.app/webhook/leads-delete"; 
        const SENDER_WEBHOOK_URL = "https://8ixs09rp.rpcld.app/webhook/toplu";
        const SEND_MESSAGE_WEBHOOK = "https://8ixs09rp.rpcld.app/webhook/manuel-outbound";
        const TOGGLE_AI_WEBHOOK = "https://8ixs09rp.rpcld.app/webhook/toggle-ai";

        const SUPABASE_URL = "https://qzvrktwfwragkqnxktpk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6dnJrdHdmd3JhZ2txbnhrdHBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjgwNTQsImV4cCI6MjA3OTc0NDA1NH0.iAzrWjs-IWZ2eoaAfmOL5XSSimUWRxXEkg225xGIt2U";
        
        const TABLE_NAME = "raw_imports";
        const LEADS_TABLE_NAME = "leads"; 
        const MESSAGES_TABLE = "conversations"; 
        const ACTIVE_CHATS_TABLE = "active_chats"; 
        const SENDER_STATE_TABLE = "sender_state"; // Yeni tablo adÄ±

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const TRANSLATIONS = {
            tr: {
                loginTitle: "GiriÅŸ Yap", username: "KullanÄ±cÄ± AdÄ±", password: "Åžifre", loginBtn: "GiriÅŸ Yap", invalidLogin: "GeÃ§ersiz kullanÄ±cÄ± adÄ± veya ÅŸifre", usernamePlaceholder: "KullanÄ±cÄ± adÄ±nÄ±zÄ± girin", passwordPlaceholder: "â€¢â€¢â€¢â€¢â€¢â€¢", menuLeads: "Veri YÃ¼kleme", menuSender: "Mesaj GÃ¶nderici", menuMessenger: "Messenger", loggedInAs: "GiriÅŸ Yapan", logout: "Ã‡Ä±kÄ±ÅŸ Yap", pageTitle: "Veri YÃ¼kleme", pageSubtitle: "Toplu mÃ¼ÅŸteri verisi yÃ¼kleme ve takip paneli.", downloadTemplate: "Åžablon Ä°ndir", templateDownloaded: "Åžablon baÅŸarÄ±yla indirildi!", templateError: "Åžablon oluÅŸturulamadÄ±.", filterUser: "KullanÄ±cÄ± Filtrele", allUsers: "TÃ¼m KullanÄ±cÄ±lar", dashboardStats: "Panel Ä°statistikleri", statTotal: "Toplam", statSuccess: "BaÅŸarÄ±lÄ±", statExist: "Mevcut", statDuplicate: "Tekrar", statError: "Hata", uploadTitle: "Dosya YÃ¼kle", labelUser: "KullanÄ±cÄ± AdÄ±", labelUserPlaceholder: "Kim yÃ¼klÃ¼yor?", labelCampaign: "Kampanya AdÄ±", labelCampaignOptional: "(Ä°steÄŸe baÄŸlÄ±)", labelCampaignPlaceholder: "Ã–rn: Yaz KampanyasÄ± 2025", dropText: "DosyayÄ± buraya sÃ¼rÃ¼kleyin", dropSubtext: "CSV veya Excel dosyalarÄ± desteklenir (Max 5MB)", selectBtn: "Bilgisayardan SeÃ§", errorNoUser: "LÃ¼tfen bir KullanÄ±cÄ± AdÄ± girin.", errorNoAmount: "LÃ¼tfen geÃ§erli bir miktar giriniz.", processingVerifying: "DoÄŸrulanÄ±yor...", processingUploading: "Veri YÃ¼kleniyor...", processingVerifyDesc: "KayÄ±tlar veritabanÄ± ile doÄŸrulanÄ±yor.", processingUploadDesc: "DosyanÄ±z Smile Zone sunucularÄ±na gÃ¼venli bir ÅŸekilde iletiliyor.", reportTitle: "YÃ¼kleme TamamlandÄ±", reportFile: "Dosya", reportUploader: "YÃ¼kleyen", reportCampaign: "Kampanya", historyTitle: "YÃ¼kleme GeÃ§miÅŸi", historyRecords: "kayÄ±t", refreshTooltip: "Tabloyu Yenile", colFile: "Dosya DetaylarÄ±", colUserCampaign: "KullanÄ±cÄ± / Kampanya", colTotal: "Toplam", colSuccess: "BaÅŸarÄ±lÄ±", colExist: "Mevcut", colDuplicate: "Tekrar", colError: "Hata", colStatus: "Durum", colActions: "Ä°ÅŸlem", statusCompleted: "TamamlandÄ±", statusUntitled: "Ä°simsiz", statusAnon: "Anonim", historyLoading: "Veriler yÃ¼kleniyor...", historyEmptyTitle: "KayÄ±t bulunamadÄ±.", historyEmptyDesc: "YÃ¼kleme geÃ§miÅŸiniz burada gÃ¶rÃ¼necektir.", historyFetchError: "GeÃ§miÅŸ verileri alÄ±namadÄ±.", msgSentChecking: "Dosya gÃ¶nderildi. VeritabanÄ± kontrol ediliyor...", msgRequestChecking: "Ä°stek gÃ¶nderildi. VeritabanÄ± kontrol ediliyor...", msgNetworkError: "AÄŸ baÄŸlantÄ±sÄ± koptu.", msgDeleted: "KayÄ±t ve ilgili veriler silinmek Ã¼zere iÅŸaretlendi.", msgDeleteError: "Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu.", deleteTitle: "KaydÄ± ve Verileri Sil", deleteConfirm: "Bu dosyayÄ± ve iÃ§inden yÃ¼klenen TÃœM verileri silmek istediÄŸinize emin misiniz?", deleteWarning: "Bu iÅŸlem geri alÄ±namaz.", deleteBtn: "Sil", deletingBtn: "Siliniyor...", cancelBtn: "Ä°ptal", senderTitle: "Toplu Mesaj GÃ¶nderici", senderSubtitle: "Otomatik kampanya mesajlaÅŸma paneli.", senderStartBtn: "BaÅŸlat", senderStopBtn: "Durdur", senderStatusSent: "GÃ¶nderildi", senderStatusDelivered: "Ä°letildi", senderStatusRead: "Okundu", senderStatusError: "Hata", senderStatusReplied: "Cevaplanan", senderReady: "HazÄ±r", senderLogTitle: "CanlÄ± GÃ¶nderim AkÄ±ÅŸÄ±", senderLogWaiting: "Sistem bekleniyor...", senderLogRunning: "Sistem Ã§alÄ±ÅŸÄ±yor...", senderDailyTitle: "Son GÃ¶nderim", senderTotalTitle: "Genel Toplam (TÃ¼m Zamanlar)", targetAmount: "Miktar", foldersTitle: "Sohbetler", searchPlaceholder: "Sohbetlerde ara...", typeMessage: "Bir mesaj yazÄ±n...", online: "Ã‡evrimiÃ§i", lastSeen: "Son gÃ¶rÃ¼lme", modeAuto: "Otomatik", modeManual: "Manuel", selectChat: "Sohbet SeÃ§in", selectChatDesc: "GÃ¶rÃ¼ÅŸmeye baÅŸlamak iÃ§in soldaki listeden bir sohbet seÃ§in.", sending: "GÃ¶nderiliyor...", systemActive: "Sistem Aktif", systemWaiting: "Sistem Bekliyor", estimatedDuration: "Tahmini SÃ¼re", elapsedTime: "GeÃ§en SÃ¼re", remainingTime: "Kalan SÃ¼re", processCompleted: "Ä°ÅŸlem TamamlandÄ±", totalRecord: "Toplam KayÄ±t",
                catAll: "TÃ¼m Sohbetler", catHot: "ðŸ”¥ SÄ±cak", catWarm: "â­ Ä°lgili", catCold: "â„ï¸ SoÄŸuk", catOther: "ðŸ“‚ DiÄŸer"
            },
            en: {
                loginTitle: "Login", username: "Username", password: "Password", loginBtn: "Login", invalidLogin: "Invalid username or password", usernamePlaceholder: "Enter your username", passwordPlaceholder: "â€¢â€¢â€¢â€¢â€¢â€¢", menuLeads: "Leads Importer", menuSender: "Bulk Sender", menuMessenger: "Messenger", loggedInAs: "Logged in as", logout: "Logout", pageTitle: "Leads Importer", pageSubtitle: "Bulk customer data upload and tracking panel.", downloadTemplate: "Download Template", templateDownloaded: "Template downloaded successfully!", templateError: "Failed to generate template.", filterUser: "Filter User", allUsers: "All Users", dashboardStats: "Dashboard Stats", statTotal: "Total Rows", statSuccess: "Success", statExist: "Exist", statDuplicate: "Duplicate", statError: "Error", uploadTitle: "Upload File", labelUser: "User Name", labelUserPlaceholder: "Who is uploading?", labelCampaign: "Campaign Name", labelCampaignOptional: "(Optional)", labelCampaignPlaceholder: "e.g. Summer Campaign 2025", dropText: "Drag & drop file here", dropSubtext: "Supports CSV or Excel files (Max 5MB)", selectBtn: "Select from Computer", errorNoUser: "Please enter a User Name.", errorNoAmount: "Please enter a valid amount.", processingVerifying: "Verifying...", processingUploading: "Uploading Data...", processingVerifyDesc: "Records are being verified with the database.", processingUploadDesc: "Your file is being securely transmitted to Smile Zone servers.", reportTitle: "Upload Complete", reportFile: "File", reportUploader: "Uploaded by", reportCampaign: "Campaign", historyTitle: "Upload History", historyRecords: "records", refreshTooltip: "Refresh Table", colFile: "File Details", colUserCampaign: "User / Campaign", colTotal: "Total", colSuccess: "Success", colExist: "Exist", colDuplicate: "Duplicate", colError: "Error", colStatus: "Status", colActions: "Action", statusCompleted: "Completed", statusUntitled: "Untitled", statusAnon: "Anonymous", historyLoading: "Loading data...", historyEmptyTitle: "No records found.", historyEmptyDesc: "Your upload history will appear here.", historyFetchError: "Failed to fetch history.", msgSentChecking: "File sent. Checking database...", msgRequestChecking: "Request sent. Checking database...", msgNetworkError: "Network connection lost.", msgDeleted: "Record and related data marked for deletion.", msgDeleteError: "Failed to delete record.", deleteTitle: "Delete Record & Data", deleteConfirm: "Are you sure you want to delete this file and ALL data imported from it?", deleteWarning: "This action cannot be undone.", deleteBtn: "Delete", deletingBtn: "Deleting...", cancelBtn: "Cancel", senderTitle: "Bulk Message Sender", senderSubtitle: "Automated campaign messaging dashboard.", senderStartBtn: "Start", senderStopBtn: "Stop", senderStatusSent: "Sent", senderStatusDelivered: "Delivered", senderStatusRead: "Read", senderStatusError: "Error", senderStatusReplied: "Replied", senderReady: "Ready", senderLogTitle: "Live Transmission Log", senderLogWaiting: "System idle...", senderLogRunning: "System running...", senderDailyTitle: "Last Sending", senderTotalTitle: "Lifetime Total", targetAmount: "Amount", foldersTitle: "Chats", searchPlaceholder: "Search chats...", typeMessage: "Type a message...", online: "Online", lastSeen: "Last seen", modeAuto: "Auto", modeManual: "Manual", selectChat: "Select Chat", selectChatDesc: "Select a chat from the left list to start messaging.", sending: "Sending...", systemActive: "System Active", systemWaiting: "System Waiting", estimatedDuration: "Estimated Duration", elapsedTime: "Elapsed Time", remainingTime: "Remaining Time", processCompleted: "Process Completed", totalRecord: "Total Records",
                catAll: "All Chats", catHot: "ðŸ”¥ Hot", catWarm: "â­ Warm", catCold: "â„ï¸ Cold", catOther: "ðŸ“‚ Other"
            }
        };

        const MOCK_USERS = [
            { id: 1, user_name: 'admin', password: 'admin', role: 'admin' },
            { id: 2, user_name: 'Burak', password: '123456', role: 'user' },
            { id: 3, user_name: 'FÄ±rat', password: '654321', role: 'user' }
        ];

        function Icon({ name, className }) {
            const elementRef = useRef(null);
            useEffect(() => {
                if (window.lucide && elementRef.current) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.setAttribute('class', className);
                    elementRef.current.innerHTML = '';
                    elementRef.current.appendChild(i);
                    window.lucide.createIcons({ root: elementRef.current });
                }
            }, [name, className]);
            return <span ref={elementRef} className="inline-flex items-center justify-center"></span>;
        }

        function SmileLogoAnimation({ isRunning, t, progressData }) {
            const animState = isRunning ? 'running' : 'paused';
            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };
            return (
                <div className="w-full h-full flex flex-col items-center justify-center bg-black text-slate-100 overflow-hidden font-sans relative">
                  <div className="scene-container">
                    <div className="layer-wrapper layer-back-anim" style={{ animationPlayState: animState }}><div className="cross-shape rotated-cross"><div className="bar horizontal" /><div className="bar vertical" /></div></div>
                    <div className="layer-wrapper layer-front-anim" style={{ animationPlayState: animState }}><div className="cross-shape straight-cross"><div className="bar horizontal" /><div className="bar vertical" /></div></div>
                    <div className="layer-wrapper layer-smile-anim" style={{ animationPlayState: animState }}><div className="smile-shape" /></div>
                    <div className="floor-glow" style={{ animationPlayState: animState }} />
                  </div>
                  <div className="mt-8 text-center space-y-4 opacity-100 z-10 flex flex-col items-center">
                    <div className="animate-fade-in transform hover:scale-105 transition-transform duration-500"><svg viewBox="0 0 300 80" className="h-16 w-auto drop-shadow-[0_0_15px_rgba(14,165,233,0.3)]" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 30H30V15C30 12.2386 32.2386 10 35 10H45C47.7614 10 50 12.2386 50 15V30H65C67.7614 30 70 32.2386 70 35V45C70 47.7614 67.7614 50 65 50H50V65C50 67.7614 47.7614 70 45 70H35C32.2386 70 30 67.7614 30 65V50H15C12.2386 50 10 47.7614 10 45V35C10 32.2386 12.2386 30 15 30Z" fill="#0099FF"/><path d="M30 42C30 42 35 48 40 48C45 48 50 42 50 42" stroke="white" strokeWidth="4" strokeLinecap="round"/><text x="85" y="40" fontFamily="Poppins, sans-serif" fontWeight="bold" fontSize="28" fill="white" style={{textShadow: "0 0 10px rgba(255,255,255,0.3)"}}>SMILE ZONE</text><text x="85" y="62" fontFamily="Poppins, sans-serif" fontWeight="bold" fontSize="20" fill="white" letterSpacing="0.05em" opacity="0.8">TURKEY</text><rect x="78" y="15" width="2" height="50" fill="#0099FF"/></svg></div>
                    <p className={`text-sm tracking-widest uppercase font-semibold transition-colors duration-500 ${isRunning ? 'text-green-400 animate-pulse' : 'text-slate-400'}`}>{isRunning ? t.systemActive : t.systemWaiting}</p>
                  </div>
                  {isRunning && progressData && (
                      <div className="absolute bottom-0 left-0 w-full bg-black/80 border-t border-cyan-900/50 backdrop-blur-md p-4 animate-fade-in z-20">
                          <div className="w-full h-1 bg-gray-800 rounded-full overflow-hidden mb-4 relative"><div className="h-full bg-cyan-50 shadow-[0_0_15px_#06b6d4] transition-all duration-1000 ease-linear relative overflow-hidden" style={{ width: `${Math.min((progressData.elapsed / progressData.total) * 100, 100)}%` }}><div className="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-transparent via-white/30 to-transparent animate-[shimmer_2s_infinite]"></div></div></div>
                          <div className="grid grid-cols-3 gap-2 text-center"><div className="flex flex-col"><span className="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">{t.totalRecord}</span><span className="text-xl font-bold text-slate-100">{progressData.targetCount}</span></div><div className="flex flex-col border-l border-slate-700/50"><span className="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">{t.elapsedTime}</span><span className="text-xl font-bold text-cyan-400 font-mono tracking-wide">{formatTime(progressData.elapsed)}</span></div><div className="flex flex-col border-l border-slate-700/50"><span className="text-xs text-slate-400 font-medium uppercase tracking-wider mb-1">{t.remainingTime}</span><span className="text-xl font-bold text-slate-100 font-mono tracking-wide">{formatTime(Math.max(0, progressData.total - progressData.elapsed))}</span></div></div>
                      </div>
                  )}
                  <style>{` .scene-container { position: relative; width: 250px; height: 250px; perspective: 1000px; transform-style: preserve-3d; } .layer-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transform-style: preserve-3d; } .bar { position: absolute; border-radius: 12px; } .cross-shape { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.5)); } .horizontal { width: 130px; height: 30px; top: 50%; left: 50%; transform: translate(-50%, -50%); } .vertical { width: 30px; height: 130px; top: 50%; left: 50%; transform: translate(-50%, -50%); } .rotated-cross { transform: translateZ(-25px) rotate(45deg); } .rotated-cross .bar { background-color: #0060ad; background: linear-gradient(135deg, #0078ff, #00509e); } .straight-cross { transform: translateZ(25px) rotate(0deg); } .straight-cross .bar { background-color: #00aaff; background: linear-gradient(135deg, #00d2ff, #008ecc); } .smile-shape { width: 28px; height: 16px; background-color: transparent; border-bottom: 3px solid #ffffff; border-left: 1px solid transparent; border-right: 1px solid transparent; border-radius: 0 0 50% 50%; filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)); transform: translateY(-2px) translateZ(40px); } .layer-back-anim { animation: anim-back 5s cubic-bezier(0.2, 0.8, 0.2, 1) infinite; } @keyframes anim-back { 0% { transform: translateZ(-600px) rotateZ(-90deg) scale(0.2); } 20% { transform: translateZ(-25px) rotateZ(0deg) scale(1); } 75% { transform: translateZ(-25px) rotateZ(5deg) scale(1); } 100% { transform: translateZ(-600px) rotateZ(90deg) scale(0.2); } } .layer-front-anim { animation: anim-front 5s cubic-bezier(0.2, 0.8, 0.2, 1) infinite; } @keyframes anim-front { 0% { transform: translateZ(600px) rotateZ(90deg) scale(0.2); } 25% { transform: translateZ(25px) rotateZ(0deg) scale(1); } 75% { transform: translateZ(25px) rotateZ(5deg) scale(1); } 100% { transform: translateZ(600px) rotateZ(-90deg) scale(0.2); } } .layer-smile-anim { animation: anim-smile 5s cubic-bezier(0.2, 0.8, 0.2, 1) infinite; } @keyframes anim-smile { 0% { transform: translateY(100px) translateZ(200px) scale(0); } 30% { transform: translateY(0) translateZ(40px) scale(1); } 75% { transform: translateY(0) translateZ(40px) rotateZ(5deg); } 100% { transform: translateY(100px) translateZ(200px) scale(0); } } .floor-glow { position: absolute; width: 250px; height: 250px; background: radial-gradient(circle, rgba(0, 200, 255, 0.4) 0%, transparent 70%); transform: translateZ(-150px); animation: pulse-glow 5s ease-in-out infinite; } @keyframes pulse-glow { 0%, 100% { transform: translateZ(-150px) scale(0.5); opacity: 0.5; } 50% { transform: translateZ(-150px) scale(1.1); opacity: 1; } } `}</style>
                </div>
            );
        }

        function ImageViewer({ src, onClose, t }) {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[100] bg-black/90 flex flex-col items-center justify-center animate-fade-in p-4">
                    <div className="absolute top-4 right-4 flex gap-4">
                        <a href={src} download="image.jpg" target="_blank" className="p-2 bg-white/10 rounded-full hover:bg-white/20 text-white transition-colors" title="Download">
                             <Icon name="download" className="w-6 h-6" />
                        </a>
                        <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20 text-white transition-colors">
                             <Icon name="x" className="w-6 h-6" />
                        </button>
                    </div>
                    <img src={src} className="max-w-full max-h-[90vh] object-contain rounded-md shadow-2xl" alt="Full view" />
                </div>
            );
        }

        function SmileZoneLogo() {
            return (
                <svg viewBox="0 0 300 80" className="h-14 w-auto" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 30H30V15C30 12.2386 32.2386 10 35 10H45C47.7614 10 50 12.2386 50 15V30H65C67.7614 30 70 32.2386 70 35V45C70 47.7614 67.7614 50 65 50H50V65C50 67.7614 47.7614 70 45 70H35C32.2386 70 30 67.7614 30 65V50H15C12.2386 50 10 47.7614 10 45V35C10 32.2386 12.2386 30 15 30Z" fill="#0099FF"/>
                    <path d="M30 42C30 42 35 48 40 48C45 48 50 42 50 42" stroke="white" strokeWidth="4" strokeLinecap="round"/>
                    <text x="85" y="40" fontFamily="Poppins, sans-serif" fontWeight="bold" fontSize="28" fill="#0099FF">SMILE ZONE</text>
                    <text x="85" y="62" fontFamily="Poppins, sans-serif" fontWeight="bold" fontSize="20" fill="#0099FF" letterSpacing="0.05em">TURKEY</text>
                    <rect x="78" y="15" width="2" height="50" fill="#0099FF"/>
                </svg>
            );
        }

        function DeleteModal({ isOpen, onClose, onConfirm, isDeleting, t, fileName }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/30 backdrop-blur-[2px] animate-fade-in">
                    <div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-6 border border-gray-100">
                        <div className="flex flex-col items-center text-center">
                            <div className="w-12 h-12 bg-red-50 text-red-500 rounded-full flex items-center justify-center mb-4">
                                {isDeleting ? <div className="spinner w-6 h-6 border-2 border-red-500 border-l-transparent"></div> : <Icon name="trash-2" className="w-6 h-6" />}
                            </div>
                            <h3 className="text-lg font-bold text-gray-900 mb-2">{t.deleteTitle}</h3>
                            <p className="text-sm text-gray-500 mb-1">{t.deleteConfirm}</p>
                            <p className="text-sm font-semibold text-gray-700 mb-4 break-all">"{fileName}"</p>
                            <p className="text-xs text-red-500 font-medium mb-6">{t.deleteWarning}</p>
                            <div className="flex gap-3 w-full">
                                <button onClick={onClose} disabled={isDeleting} className="flex-1 px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 transition-colors disabled:opacity-50">{t.cancelBtn}</button>
                                <button onClick={onConfirm} disabled={isDeleting} className="flex-1 px-4 py-2 bg-red-600 rounded-lg text-white font-medium hover:bg-red-700 transition-colors disabled:opacity-70 flex items-center justify-center gap-2">{isDeleting ? t.deletingBtn : t.deleteBtn}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function LoginOverlay({ onLogin, t, language, toggleLanguage }) {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                const user = MOCK_USERS.find(u => u.user_name === username && u.password === password);
                if (user) { onLogin(user); } else { setError(t.invalidLogin); }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/10 backdrop-blur-[4px]">
                    <div className="absolute top-6 right-6 z-50">
                        <button onClick={toggleLanguage} className="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-bold text-gray-600 hover:text-brand-600 hover:border-brand-200 transition-all shadow-sm flex items-center gap-2"><Icon name="globe" className="w-4 h-4" />{language === 'tr' ? 'EN' : 'TR'}</button>
                    </div>
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-100 transform transition-all scale-100 animate-fade-in relative">
                        <div className="flex justify-center mb-8"><SmileZoneLogo /></div>
                        <h2 className="text-xl font-bold text-gray-800 text-center mb-6">{t.loginTitle}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">{t.username}</label><input type="text" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder={t.usernamePlaceholder} value={username} onChange={(e) => setUsername(e.target.value)} /></div>
                            <div><label className="block text-sm font-medium text-gray-700 mb-1">{t.password}</label><input type="password" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none transition-all" placeholder={t.passwordPlaceholder} value={password} onChange={(e) => setPassword(e.target.value)} /></div>
                            {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                            <button type="submit" className="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg shadow-md transition-all">{t.loginBtn}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function Sidebar({ currentUser, onLogout, t, activeMenu, setActiveMenu }) {
            return (
                <div className="hidden md:flex flex-col w-64 bg-white border-r border-gray-200 h-screen fixed left-0 top-0 z-40 shadow-lg">
                    <div className="p-6 flex items-center justify-center border-b border-gray-100 h-24">
                        <div className="flex flex-col items-center"><div className="mb-1"><SmileZoneLogo /></div></div>
                    </div>
                    <nav className="flex-1 p-4 mt-4 space-y-2 overflow-y-auto custom-scroll">
                        <button onClick={() => setActiveMenu('leads')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-semibold transition-all ${activeMenu === 'leads' ? 'bg-brand-50 text-brand-700 border border-brand-100 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Icon name="upload-cloud" className="w-5 h-5" />{t.menuLeads}</button>
                        <button onClick={() => setActiveMenu('sender')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-semibold transition-all ${activeMenu === 'sender' ? 'bg-brand-50 text-brand-700 border border-brand-100 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Icon name="send" className="w-5 h-5" />{t.menuSender}</button>
                        <button onClick={() => setActiveMenu('messenger')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-semibold transition-all ${activeMenu === 'messenger' ? 'bg-brand-50 text-brand-700 border border-brand-100 shadow-sm' : 'text-gray-500 hover:bg-gray-50'}`}><Icon name="message-circle" className="w-5 h-5" />{t.menuMessenger}</button>
                    </nav>
                    {currentUser && (
                        <div className="p-4 border-t border-gray-100 bg-gray-50">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold">
                                    {currentUser.user_name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p className="text-xs text-gray-500">{t.loggedInAs}</p>
                                    <p className="text-sm font-semibold text-gray-800">{currentUser.user_name}</p>
                                </div>
                            </div>
                            <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-3 py-2 text-xs font-medium text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <Icon name="log-out" className="w-3 h-3" />{t.logout}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        function PastelStatsGrid({ title, data, icon, t }) {
             return (
                <div className="mb-8 animate-fade-in w-full">
                    {title && <div className="flex items-center gap-2 mb-4"><h2 className="text-lg font-semibold text-brand-600 flex items-center gap-2">{icon && <Icon name={icon} className="w-5 h-5 text-gray-500" />}{title}</h2></div>}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                        {data.total !== undefined && data.sent === undefined ? (
                            <>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-gray-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider">{t.statTotal}</h3><div className="p-2 bg-gray-50 rounded-lg text-gray-400 group-hover:bg-gray-100 transition-colors"><Icon name="database" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-gray-800">{data.total.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-green-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-green-600/70 uppercase tracking-wider">{t.statSuccess}</h3><div className="p-2 bg-green-50 rounded-lg text-green-600"><Icon name="check-circle-2" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-green-600">{data.success.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-brand-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-brand-600/70 uppercase tracking-wider">{t.statExist}</h3><div className="p-2 bg-brand-50 rounded-lg text-brand-600"><Icon name="info" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-brand-700">{data.exist.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-orange-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-orange-500/70 uppercase tracking-wider">{t.statDuplicate}</h3><div className="p-2 bg-orange-50 rounded-lg text-orange-600"><Icon name="copy" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-orange-500">{data.duplicate.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-red-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-red-500/70 uppercase tracking-wider">{t.statError}</h3><div className="p-2 bg-red-50 rounded-lg text-red-600"><Icon name="alert-triangle" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-red-600">{data.error.toLocaleString()}</p></div>
                            </>
                        ) : (
                            <>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-gray-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">{t.statTotal}</h3><div className="p-2 bg-gray-50 rounded-lg text-gray-500 group-hover:bg-gray-100 transition-colors"><Icon name="layers" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-gray-700">{data.total?.toLocaleString() || 0}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-blue-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-blue-600/70 uppercase tracking-wider">{t.senderStatusSent}</h3><div className="p-2 bg-blue-50 rounded-lg text-blue-600 group-hover:bg-blue-100 transition-colors"><Icon name="send" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-blue-700">{data.sent.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-green-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-green-600/70 uppercase tracking-wider">{t.senderStatusDelivered}</h3><div className="p-2 bg-green-50 rounded-lg text-green-600 group-hover:bg-green-100 transition-colors"><Icon name="check" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-green-600">{data.delivered.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-purple-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-purple-600/70 uppercase tracking-wider">{t.senderStatusRead}</h3><div className="p-2 bg-purple-50 rounded-lg text-purple-600 group-hover:bg-purple-100 transition-colors"><Icon name="check-check" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-purple-700">{data.read.toLocaleString()}</p></div>
                                <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 stat-card group hover:border-red-200"><div className="flex items-center justify-between mb-3"><h3 className="text-xs font-bold text-red-600/70 uppercase tracking-wider">{t.senderStatusError}</h3><div className="p-2 bg-red-50 rounded-lg text-red-600 group-hover:bg-red-100 transition-colors"><Icon name="alert-triangle" className="w-5 h-5" /></div></div><p className="text-2xl font-bold text-red-600">{data.error.toLocaleString()}</p></div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        function PremiumStatsBar({ title, data, icon, t }) {
            const statsConfig = [
                { key: 'total', label: t.statTotal, icon: 'layers', colorClass: 'bg-white/20 text-white', valueClass: 'text-white' },
                { key: 'sent', label: t.senderStatusSent, icon: 'send', colorClass: 'bg-blue-400/20 text-blue-100', valueClass: 'text-blue-50' },
                { key: 'delivered', label: t.senderStatusDelivered, icon: 'check', colorClass: 'bg-green-400/20 text-green-100', valueClass: 'text-green-50' },
                { key: 'read', label: t.senderStatusRead, icon: 'check-check', colorClass: 'bg-purple-400/20 text-purple-100', valueClass: 'text-purple-50' },
                { key: 'error', label: t.senderStatusError, icon: 'alert-circle', colorClass: 'bg-red-400/20 text-red-100', valueClass: 'text-red-50' },
                { key: 'replied', label: t.senderStatusReplied, icon: 'message-circle', colorClass: 'bg-cyan-400/20 text-cyan-100', valueClass: 'text-cyan-50' },
            ];

            return (
                <div className="mb-6 p-6 rounded-2xl relative overflow-hidden bg-white shadow-xl transition-all border border-gray-100">
                    <div className="relative z-10">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <Icon name={icon || "bar-chart-2"} className="w-5 h-5 text-brand-600" />{title}
                            </h2>
                        </div>
                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
                            {statsConfig.map(stat => (
                                <div key={stat.key} className={`flex flex-col p-4 rounded-xl border ${stat.key === 'total' ? 'bg-gray-50 border-gray-200' : 
                                    stat.key === 'sent' ? 'bg-blue-50 border-blue-200' : 
                                    stat.key === 'delivered' ? 'bg-green-50 border-green-200' :
                                    stat.key === 'read' ? 'bg-purple-50 border-purple-200' :
                                    stat.key === 'error' ? 'bg-red-50 border-red-200' : 
                                    'bg-cyan-50 border-cyan-200'}`}>
                                    <div className="flex items-center justify-between mb-2">
                                        <span className={`text-xs font-bold uppercase tracking-wide ${stat.key === 'total' ? 'text-gray-500' : stat.key === 'sent' ? 'text-blue-600' : stat.key === 'delivered' ? 'text-green-600' : stat.key === 'read' ? 'text-purple-600' : stat.key === 'error' ? 'text-red-600' : 'text-cyan-600'}`}>{stat.label}</span>
                                        <div className={`p-1.5 rounded-full ${stat.key === 'total' ? 'bg-gray-200 text-gray-600' : stat.key === 'sent' ? 'bg-blue-200 text-blue-700' : stat.key === 'delivered' ? 'bg-green-200 text-green-700' : stat.key === 'read' ? 'bg-purple-200 text-purple-700' : stat.key === 'error' ? 'bg-red-200 text-red-700' : 'bg-cyan-200 text-cyan-700'}`}>
                                            <Icon name={stat.icon} className="w-4 h-4" />
                                        </div>
                                    </div>
                                    <span className="text-2xl font-bold text-gray-800">{data[stat.key]?.toLocaleString() || 0}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function GlobalStats({ history, selectedUser, onUserChange, uniqueUsers, currentUser, t }) {
            const effectiveSelectedUser = currentUser.role === 'admin' ? selectedUser : currentUser.user_name;
            const filteredHistory = useMemo(() => { if (!effectiveSelectedUser) return history; return history.filter(item => (item.user_name || 'Anonymous') === effectiveSelectedUser); }, [history, effectiveSelectedUser]);
            const stats = useMemo(() => { return filteredHistory.reduce((acc, curr) => ({ total: acc.total + (Number(curr.total_rows) || 0), success: acc.success + (Number(curr.success_count) || 0), duplicate: acc.duplicate + (Number(curr.duplicate_count) || 0), exist: acc.exist + (Number(curr.exist_count) || 0), error: acc.error + (Number(curr.error_count) || 0) }), { total: 0, success: 0, duplicate: 0, exist: 0, error: 0 }); }, [filteredHistory]);
            return (
                <div className="mb-8 animate-fade-in w-full">
                    <div className="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                        <div className="w-full">
                            <div className="flex justify-between items-end mb-4">
                                <h2 className="text-lg font-semibold text-brand-600 flex items-center gap-2"><Icon name="bar-chart-2" className="w-5 h-5 text-gray-500" />{t.dashboardStats}</h2>
                                {currentUser.role === 'admin' && (<div className="flex flex-col gap-1 w-full md:w-auto min-w-[200px]"><label className="text-xs font-semibold text-gray-400 uppercase tracking-wide">{t.filterUser}</label><div className="relative"><select value={selectedUser} onChange={(e) => onUserChange(e.target.value)} className="w-full pl-3 pr-10 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 appearance-none shadow-sm cursor-pointer font-medium"><option value="">{t.allUsers}</option>{uniqueUsers.map(user => (<option key={user} value={user}>{user}</option>))}</select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><Icon name="chevron-down" className="w-4 h-4" /></div></div></div>)}
                            </div>
                            <PastelStatsGrid title="" data={stats} icon="" t={t} />
                        </div>
                    </div>
                </div>
            );
        }

        function UploadArea({ onFileSelect, uploading, userName, setUserName, campaignName, setCampaignName, onError, currentUser, t }) {
            const inputRef = useRef(null);
            useEffect(() => { if (currentUser) setUserName(currentUser.user_name); }, [currentUser, setUserName]);
            const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); };
            const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); if (!userName.trim()) { onError(t.errorNoUser); document.getElementById('userNameInput')?.focus(); return; } if (e.dataTransfer.files && e.dataTransfer.files[0]) onFileSelect(e.dataTransfer.files[0]); };
            const handleAreaClick = () => { if (uploading) return; if (!userName.trim()) { onError(t.errorNoUser); document.getElementById('userNameInput')?.focus(); return; } if (inputRef.current) inputRef.current.click(); };

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
                    <div className="flex items-center gap-3 mb-8"><div className="w-1 h-8 bg-brand-500 rounded-full"></div><h2 className="text-lg font-bold text-brand-600">{t.uploadTitle}</h2></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div><label className="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-2">{t.labelUser} <span className="text-red-500">*</span></label><div className="relative group"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"><Icon name="user" className="w-4 h-4" /></div><input id="userNameInput" type="text" value={userName} readOnly={currentUser.role !== 'admin'} onChange={(e) => setUserName(e.target.value)} placeholder={t.labelUserPlaceholder} className={`w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg text-sm outline-none transition-all ${currentUser.role !== 'admin' ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : 'bg-gray-50 focus:bg-white focus:ring-2 focus:ring-brand-400 focus:border-brand-400'}`} /></div></div>
                        <div><label className="block text-xs font-bold text-gray-700 uppercase tracking-wide mb-2">{t.labelCampaign} <span className="text-gray-400 font-normal normal-case">{t.labelCampaignOptional}</span></label><div className="relative group"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-brand-500 transition-colors pointer-events-none"><Icon name="flag" className="w-4 h-4" /></div><input id="campaignNameInput" type="text" value={campaignName} onChange={(e) => setCampaignName(e.target.value)} placeholder={t.labelCampaignPlaceholder} className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-brand-400 focus:border-brand-400 outline-none transition-all bg-gray-50 focus:bg-white placeholder-gray-400" /></div></div>
                    </div>
                    <div className={`border-2 border-dashed rounded-xl p-12 text-center transition-all cursor-pointer select-none relative overflow-hidden group ${uploading ? 'bg-gray-50 border-gray-300 opacity-50 cursor-not-allowed' : 'border-brand-200 hover:border-brand-400 hover:bg-brand-50/20 bg-white'}`} onDragOver={handleDragOver} onDrop={handleDrop} onClick={handleAreaClick}>
                        <input type="file" ref={inputRef} className="hidden" accept=".csv,.xlsx,.xls" multiple onChange={(e) => { if (e.target.files && e.target.files[0]) { onFileSelect(e.target.files[0]); e.target.value = ''; } }} disabled={uploading} />
                        <div className="flex flex-col items-center justify-center gap-4 pointer-events-none relative z-10"><div className="w-20 h-20 bg-brand-50 text-brand-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-sm border border-brand-100"><Icon name="upload" className="w-10 h-10" /></div><div><h3 className="text-xl font-bold text-gray-900">{t.dropText}</h3><p className="text-sm text-gray-500 mt-2">{t.dropSubtext}</p></div><button type="button" className="px-8 py-3 bg-brand-600 hover:bg-brand-700 text-white font-semibold rounded-lg shadow-lg shadow-brand-600/20 transition-all mt-4 pointer-events-auto transform hover:-translate-y-0.5 border border-transparent" onClick={(e) => { e.stopPropagation(); handleAreaClick(); }} disabled={uploading}>{t.selectBtn}</button></div>
                    </div>
                </div>
            );
        }

        function ProcessingState({ isSearching, t }) {
            return (
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 p-12 flex flex-col items-center justify-center min-h-[400px]">
                    <div className="spinner mb-8"></div>
                    <h3 className="text-2xl font-bold text-brand-900 mb-3">{isSearching ? t.processingVerifying : t.processingUploading}</h3>
                    <p className="text-gray-500 text-center max-w-md text-lg">{isSearching ? t.processingVerifyDesc : t.processingUploadDesc}</p>
                    <div className="w-full max-w-md bg-gray-100 rounded-full h-2 mt-10 overflow-hidden"><div className="bg-brand-500 h-2 rounded-full w-2/3 animate-[pulse_1.5s_ease-in-out_infinite]"></div></div>
                </div>
            );
        }

        function ReportSummary({ summary, t }) {
            const campaignName = summary.campaignName;
            return (
                <div className="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 mb-8 animate-fade-in border-l-[6px] border-l-brand-500 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-6 opacity-5 pointer-events-none text-brand-900"><Icon name="clipboard-check" className="w-32 h-32" /></div>
                    <div className="flex flex-col sm:flex-row justify-between items-start mb-8 gap-4 relative z-10"><div><div className="flex items-center gap-3 mb-2"><div className="p-1.5 bg-green-100 rounded-full text-green-700"><Icon name="check" className="w-5 h-5" /></div><h2 className="text-xl font-bold text-gray-900">{t.reportTitle}</h2></div><p className="text-sm text-gray-500 ml-1">{t.reportFile}: <span className="font-semibold text-brand-700 bg-brand-50 px-2 py-0.5 rounded">{summary.fileName}</span></p></div></div>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-4 relative z-10">
                        <div className="p-5 bg-gray-50 rounded-xl border border-gray-100 flex flex-col items-center text-center"><span className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">{t.colTotal}</span><span className="text-3xl font-bold text-gray-800">{summary.total_rows}</span></div>
                        <div className="p-5 bg-green-50 rounded-xl border border-green-100 flex flex-col items-center text-center"><span className="text-xs font-bold text-green-700 uppercase tracking-wider mb-2">{t.colSuccess}</span><span className="text-3xl font-bold text-green-700">{summary.success_count}</span></div>
                        <div className="p-5 bg-brand-50 rounded-xl border border-brand-100 flex flex-col items-center text-center"><span className="text-xs font-bold text-brand-700 uppercase tracking-wider mb-2">{t.colExist}</span><span className="text-3xl font-bold text-brand-700">{summary.exist_count}</span></div>
                        <div className="p-5 bg-orange-50 rounded-xl border border-orange-100 flex flex-col items-center text-center"><span className="text-xs font-bold text-orange-600 uppercase tracking-wider mb-2">{t.colDuplicate}</span><span className="text-3xl font-bold text-orange-600">{summary.duplicate_count}</span></div>
                        <div className="p-5 bg-red-50 rounded-xl border border-red-100 flex flex-col items-center text-center"><span className="text-xs font-bold text-red-600 uppercase tracking-wider mb-2">{t.colError}</span><span className="text-3xl font-bold text-red-600">{summary.error_count}</span></div>
                    </div>
                    <div className="mt-6 pt-6 border-t border-gray-100 flex items-center gap-6 text-sm text-gray-500"><div className="flex items-center gap-2"><div className="text-brand-500"><Icon name="user" className="w-4 h-4" /></div>{t.reportUploader}: <span className="font-semibold text-gray-700">{summary.userName}</span></div>{campaignName && (<div className="flex items-center gap-2"><div className="text-brand-500"><Icon name="flag" className="w-4 h-4" /></div>{t.reportCampaign}: <span className="font-semibold text-gray-700">{campaignName}</span></div>)}</div>
                </div>
            );
        }

        function HistoryTable({ history, selectedUser, isLoading, onRefresh, currentUser, currentLang, t, onDelete }) {
            const effectiveSelectedUser = currentUser.role === 'admin' ? selectedUser : currentUser.user_name;
            const filteredHistory = useMemo(() => {
                if (currentUser.role !== 'admin') {
                    return history.filter(item => (item.user_name || 'Anonymous') === currentUser.user_name);
                }
                if (selectedUser) {
                    return history.filter(item => (item.user_name || 'Anonymous') === selectedUser);
                }
                return history;
            }, [history, selectedUser, currentUser]);
            
            const formatDate = (dateStr) => { 
                if (!dateStr) return '-'; 
                const date = new Date(dateStr); 
                const locale = currentLang === 'en' ? 'en-US' : 'tr-TR'; 
                return date.toLocaleDateString(locale, { day: 'numeric', month: 'short', hour: '2-digit', minute:'2-digit' }); 
            };
            const canDelete = (item) => currentUser.role === 'admin' || (item.user_name === currentUser.user_name);
            
            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden min-h-[400px]">
                    <div className="p-6 border-b border-gray-100 flex items-center justify-between bg-white">
                        <div className="flex items-center gap-3"><div className="w-1 h-6 bg-brand-600 rounded-full"></div><h3 className="text-lg font-bold text-gray-900">{t.historyTitle}</h3></div>
                        <div className="flex items-center gap-3"><span className="text-xs bg-gray-50 text-gray-600 px-3 py-1.5 rounded-full font-bold">{filteredHistory.length} {t.historyRecords}</span><button onClick={onRefresh} className="p-2 bg-gray-50 hover:bg-brand-50 rounded-full text-gray-400 hover:text-brand-500 transition-colors" title={t.refreshTooltip}><Icon name="refresh-cw" className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`} /></button></div>
                    </div>
                    <div className="overflow-x-auto custom-scroll flex-1">
                        <table className="w-full text-left border-collapse min-w-[1000px]">
                            <thead><tr className="bg-gray-50/50 border-b border-gray-100"><th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colFile}</th><th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colUserCampaign}</th><th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colTotal}</th><th className="px-6 py-4 text-xs font-bold text-green-700 uppercase tracking-wider text-right sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colSuccess}</th><th className="px-6 py-4 text-xs font-bold text-brand-700 uppercase tracking-wider text-right sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colExist}</th><th className="px-6 py-4 text-xs font-bold text-orange-600 uppercase tracking-wider text-right sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colDuplicate}</th><th className="px-6 py-4 text-xs font-bold text-red-600 uppercase tracking-wider text-right sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colError}</th><th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colStatus}</th><th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-right sticky top-0 bg-gray-50/90 backdrop-blur-sm z-10">{t.colActions}</th></tr></thead>
                            <tbody className="divide-y divide-gray-100">
                                {isLoading ? (
                                    <tr><td colSpan="9" className="px-6 py-12 text-center text-sm text-gray-500"><div className="flex flex-col items-center justify-center gap-3"><div className="spinner w-6 h-6 border-2"></div><span>{t.historyLoading}</span></div></td></tr>
                                ) : filteredHistory.length > 0 ? ( 
                                    filteredHistory.map((item) => { 
                                        const cName = item.campaign_name || item['Campaign Name']; 
                                        return (
                                            <tr key={item.id} className="hover:bg-gray-50 transition-colors group">
                                                <td className="px-6 py-4"><div className="flex items-center gap-3"><div className="p-2 bg-brand-50 text-brand-600 rounded-lg group-hover:bg-brand-100 transition-colors"><Icon name="file-spreadsheet" className="w-4 h-4" /></div><div><div className="text-sm font-semibold text-gray-900 max-w-[150px] truncate" title={item.file_name}>{item.file_name || t.statusUntitled}</div><div className="text-xs text-gray-400 mt-0.5">{formatDate(item.created_at)}</div></div></div></td>
                                                <td className="px-6 py-4"><div className="flex flex-col"><div className="flex items-center gap-2 mb-1"><div className="text-gray-300"><Icon name="user" className="w-3 h-3" /></div><span className="text-sm text-gray-600">{item.user_name || t.statusAnon}</span></div>{cName && (<span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-brand-50 text-brand-700 w-fit max-w-[150px] truncate" title={cName}>{cName}</span>)}</div></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right font-medium">{item.total_rows}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-green-700 text-right font-bold bg-green-50/20">{item.success_count}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-brand-700 text-right font-bold bg-brand-50/20">{item.exist_count || 0}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-orange-600 text-right font-medium">{item.duplicate_count}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-red-600 text-right font-medium">{item.error_count}</td>
                                                <td className="px-6 py-4 whitespace-nowrap"><span className={`px-2.5 py-1 inline-flex items-center gap-1.5 text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800`}><span className="w-1.5 h-1.5 rounded-full bg-green-500"></span>{t.statusCompleted}</span></td>
                                                <td className="px-6 py-4 whitespace-nowrap text-right">{canDelete(item) && (<button onClick={() => onDelete(item)} className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title={t.deleteBtn}><Icon name="trash-2" className="w-4 h-4" /></button>)}</td>
                                            </tr>
                                        ); 
                                    }) 
                                ) : (
                                    <tr><td colSpan="9" className="px-6 py-16 text-center text-sm text-gray-500"><div className="flex flex-col items-center gap-3"><div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-400"><Icon name="inbox" className="w-6 h-6" /></div><div><span className="font-semibold text-gray-600 block">{t.historyEmptyTitle}</span><p className="text-xs text-gray-400 mt-1">{t.historyEmptyDesc}</p></div></div></td></tr>
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function BulkSenderPage({ t, setAlert, currentUser, uniqueUsers }) {
            const [isSending, setIsSending] = useState(false);
            const [targetCount, setTargetCount] = useState('');
            const [sessionStartTime, setSessionStartTime] = useState(null); 
            const [dailyStats, setDailyStats] = useState({ sent: 0, delivered: 0, read: 0, error: 0, total: 0 }); 
            const [totalStats, setTotalStats] = useState({ sent: 0, delivered: 0, read: 0, error: 0, total: 0, replied: 0 }); 
            const [senderSelectedUser, setSenderSelectedUser] = useState(""); 
            const [progressData, setProgressData] = useState({ total: 0, elapsed: 0, targetCount: 0 });
            const [readyCount, setReadyCount] = useState(0); 
            const [broadcastDates, setBroadcastDates] = useState([]);
            const [selectedDate, setSelectedDate] = useState('');
            
            useEffect(() => {
                if (currentUser.role !== 'admin') {
                    setSenderSelectedUser(currentUser.user_name);
                }
            }, [currentUser]);

            const fetchData = useCallback(async () => {
                const { data: statsData, error: statsError } = await supabase
                    .from(LEADS_TABLE_NAME)
                    .select('last_status, broadcast_date, user_name, phone')
		    .range(0, 99999);

                const { data: chatsData, error: chatsError } = await supabase
                    .from(ACTIVE_CHATS_TABLE)
                    .select('lead_phone');

                if (statsError) {
                    console.error('Stats fetch error:', statsError);
                    return;
                }

                if (statsData) {
                    const newTotal = { sent: 0, delivered: 0, read: 0, error: 0, total: 0, replied: 0 };
                    
                    const filterUser = currentUser.role === 'admin' ? senderSelectedUser : currentUser.user_name;
                    const filteredData = filterUser ? statsData.filter(d => d.user_name === filterUser) : statsData;

                    const freshCount = filteredData.filter(d => (d.last_status || '').trim() === 'fresh').length;
                    setReadyCount(freshCount);

                    if (chatsData) {
                         const activePhones = new Set(chatsData.map(c => c.lead_phone));
                         const repliedCount = filteredData.filter(l => activePhones.has(l.phone)).length;
                         newTotal.replied = repliedCount;
                    }

                    filteredData.forEach(row => {
                        const status = (row.last_status || '').toLowerCase().trim();
                        let key = null;
                        if (status === 'sent') key = 'sent';
                        else if (status === 'delivered') key = 'delivered';
                        else if (status === 'read') key = 'read';
                        else if (status === 'failed') key = 'error';

                        if (key) {
                            newTotal[key]++;
                            newTotal.total++; 
                        }
                    });
                    
                    // --- LOGIC FOR DATE DROPDOWN & SPECIFIC BATCH STATS ---
                    const uniqueDates = [...new Set(filteredData.map(d => d.broadcast_date).filter(d => d))].sort().reverse();
                    setBroadcastDates(uniqueDates);

                    // Determine which date to show stats for
                    // If user hasn't selected one, default to the latest one
                    const dateToShow = selectedDate || (uniqueDates.length > 0 ? uniqueDates[0] : null);
                    
                    let newDaily = { sent: 0, delivered: 0, read: 0, error: 0, total: 0 };

                    if (dateToShow) {
                        const batchRows = filteredData.filter(d => d.broadcast_date === dateToShow);
                        batchRows.forEach(row => {
                            const status = (row.last_status || '').toLowerCase().trim();
                            let key = null;
                            if (status === 'sent') key = 'sent';
                            else if (status === 'delivered') key = 'delivered';
                            else if (status === 'read') key = 'read';
                            else if (status === 'failed') key = 'error';

                            if (key) {
                                newDaily[key]++;
                                newDaily.total++; 
                            }
                        });
                    }

                    setTotalStats(newTotal);
                    setDailyStats(newDaily);
                }
            }, [currentUser, senderSelectedUser, selectedDate]); 

            useEffect(() => {
                let interval;
                if (isSending && progressData.total > 0) {
                    interval = setInterval(() => {
                        setProgressData(prev => {
                            const newElapsed = prev.elapsed + 1;
                            
                            // SÃœRE DOLDU MU KONTROLÃœ
                            if (newElapsed >= prev.total) {
                                // SÃ¼re dolduÄŸunda otomatik durdur ve sÄ±fÄ±rla
                                setTimeout(() => {
                                    setIsSending(false);
                                    setProgressData(p => ({ ...p, elapsed: 0, total: 0 }));
                                }, 500);
                                
                                return { ...prev, elapsed: prev.total };
                            }
                            
                            return { ...prev, elapsed: newElapsed };
                        });
                    }, 1000); 
                }
                return () => clearInterval(interval);
            }, [isSending, progressData.total]);

            useEffect(() => {
                fetchData(); 
                const intervalId = setInterval(fetchData, 5000);
                const channel = supabase.channel('realtime-leads-update').on('postgres_changes', { event: '*', schema: 'public', table: LEADS_TABLE_NAME }, () => { fetchData(); }).subscribe();
                return () => { clearInterval(intervalId); supabase.removeChannel(channel); };
            }, [fetchData]);

            const startSystem = async () => {
                if(isSending) return;
                if(!targetCount || parseInt(targetCount) <= 0) {
                    setAlert({type: 'error', message: t.errorNoAmount});
                    return;
                }
                
                const amount = parseInt(targetCount);
                const totalSeconds = amount * 10;
                
                // Reset everything on start
                setSessionStartTime(new Date().getTime());
                setProgressData({ total: totalSeconds, elapsed: 0, targetCount: amount });
                setIsSending(true);
                
                try { 
                    await fetch(SENDER_WEBHOOK_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ action: 'start', batch_limit: amount }) 
                    }); 
                } catch (e) { 
                    console.error("Webhook Start Error", e); 
                    setIsSending(false); 
                }
            };

            const stopSystem = async () => {
                setIsSending(false);
                setProgressData(prev => ({...prev, elapsed: 0, total: 0})); 
                
                // Supabase Ã¼zerinden action kolonunu 'stop' olarak gÃ¼ncelle
                try { 
                    await supabase
                        .from(SENDER_STATE_TABLE)
                        .update({ action: 'stop' })
                        .eq('id', 1) // Ä°lk satÄ±rÄ± gÃ¼ncelliyoruz
                        .select(); 
                } catch (e) { 
                    console.error("Supabase Stop State Update Error", e); 
                }
            };

            return (
                <div className="animate-fade-in w-full pb-8">
                    <div className="flex flex-col md:flex-row justify-between items-end mb-8 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm gap-4">
                        <div className="flex items-center gap-4"><div className="w-12 h-12 rounded-xl bg-brand-50 text-brand-600 flex items-center justify-center shadow-inner"><Icon name="message-square" className="w-6 h-6" /></div><div><h1 className="text-2xl font-bold text-brand-600">{t.senderTitle}</h1><p className="text-sm text-brand-500 font-medium">{t.senderSubtitle}</p></div></div>
                        {currentUser.role === 'admin' && (<div className="flex flex-col gap-1 w-full md:w-auto min-w-[200px]"><label className="text-xs font-semibold text-gray-400 uppercase tracking-wide">{t.filterUser}</label><div className="relative"><select value={senderSelectedUser} onChange={(e) => setSenderSelectedUser(e.target.value)} className="w-full pl-3 pr-10 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 appearance-none shadow-sm cursor-pointer font-medium"><option value="">{t.allUsers}</option>{uniqueUsers.map(user => (<option key={user} value={user}>{user}</option>))}</select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><Icon name="chevron-down" className="w-4 h-4" /></div></div></div>)}
                    </div>
                    
                    <PremiumStatsBar title={t.senderTotalTitle} data={totalStats} icon="globe" t={t} />
                    
                    <div className="border-t border-gray-200 my-6"></div>
                    
                    {/* Last Sending Section with Date Selector */}
                    <div className="flex flex-col md:flex-row justify-between items-end mb-4">
                        <h2 className="text-lg font-semibold text-brand-600 flex items-center gap-2 mb-2 md:mb-0"><Icon name="calendar" className="w-5 h-5 text-gray-500" />{t.senderDailyTitle}</h2>
                        <div className="relative w-full md:w-64">
                             <select 
                                value={selectedDate} 
                                onChange={(e) => setSelectedDate(e.target.value)} 
                                className="w-full pl-3 pr-10 py-2 bg-white border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 appearance-none shadow-sm cursor-pointer font-medium"
                             >
                                <option value="">En Son GÃ¶nderim</option>
                                {broadcastDates.map(date => (
                                    <option key={date} value={date}>{date}</option>
                                ))}
                             </select>
                             <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"><Icon name="chevron-down" className="w-4 h-4" /></div>
                        </div>
                    </div>
                    
                    <PastelStatsGrid title="" data={dailyStats} icon="" t={t} />
                    
                    <div className="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden mt-6">
                        <div className="p-4 border-b border-gray-100 bg-gray-50 flex flex-col md:flex-row items-center justify-between gap-4">
                            <h3 className="font-bold text-brand-600 flex items-center gap-2"><Icon name="activity" className="w-4 h-4 text-brand-600" />{t.senderLogTitle}{isSending && <span className="flex h-3 w-3 relative ml-2"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span>}</h3>
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <div className="flex items-center gap-2">
                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-wide">{t.senderReady}:</span>
                                    <span className="px-2.5 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-bold border border-green-200 shadow-sm flex items-center gap-1.5">
                                        <span className="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                        {readyCount}
                                    </span>
                                </div>
                                <div className="w-px h-6 bg-gray-200 mx-1 hidden md:block"></div>
                                <div className="flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-3 py-1.5 focus-within:ring-2 focus-within:ring-brand-500 h-9 transition-all hover:border-brand-200"><span className="text-gray-500 text-xs font-bold whitespace-nowrap">{t.targetAmount}:</span><input type="number" value={targetCount} onChange={(e) => setTargetCount(e.target.value)} placeholder="âˆž" className="border-none outline-none text-sm font-semibold w-20 p-0 text-gray-800 bg-transparent disabled:opacity-50 disabled:cursor-not-allowed" disabled={isSending || currentUser.role !== 'admin'} /></div>
                                {currentUser.role === 'admin' ? (!isSending ? (<button onClick={startSystem} className="px-4 py-1.5 rounded-lg font-bold text-xs text-white bg-brand-600 hover:bg-brand-700 shadow-md transition-all flex items-center gap-1 h-9"><Icon name="play" className="w-3 h-3" /> {t.senderStartBtn}</button>) : (<button onClick={stopSystem} className="px-4 py-1.5 rounded-lg font-bold text-xs text-white bg-red-500 hover:bg-red-600 shadow-md transition-all flex items-center gap-1 h-9"><Icon name="pause" className="w-3 h-3" /> {t.senderStopBtn}</button>)) : (<div className="px-3 py-1.5 bg-gray-100 rounded-lg text-xs font-bold text-gray-400 flex items-center gap-1 h-9 select-none cursor-not-allowed"><Icon name="lock" className="w-3 h-3" /> Admin Only</div>)}
                            </div>
                        </div>
                        <div className="h-96 w-full relative"><SmileLogoAnimation isRunning={isSending} t={t} progressData={isSending ? progressData : null} /></div>
                    </div>
                </div>
            );
        }

        // --- UPDATED MESSAGE BUBBLE COMPONENT ---
       function MessageBubble({ msg, isOutgoing, onImageClick }) {
    // 1. Medya URL HazÄ±rlÄ±ÄŸÄ±
    const mediaUrl = msg.media_storage_path 
        ? `${SUPABASE_URL}/storage/v1/object/public/${msg.media_storage_path}`
        : (msg.media_url || null);

    // 2. KONTROLLER
    // KullanÄ±cÄ±nÄ±n isteÄŸi: Sadece type 'audio' ise ses muamelesi yap.
    const isAudio = msg.type === 'audio';

    // GÃ¶rsel kontrolÃ¼ (Ses deÄŸilse ve resim uzantÄ±sÄ± varsa veya type image ise)
    const isImage = !isAudio && mediaUrl && (msg.type === 'image' || /\.(jpg|jpeg|png|gif|webp)$/i.test(mediaUrl));

    // Saat Ã‡akÄ±ÅŸma KontrolÃ¼: 
    // Sadece "Metinsiz Saf Resim" ise saat resmin Ã¼zerine biner.
    // Ses dosyasÄ± veya metin varsa saat aÅŸaÄŸÄ±ya iner.
    const isTimeOverlay = isImage && !msg.body;

    const getStatusIcon = () => {
        if (!isOutgoing) return null;
        if (msg.status === 'read') return <span className="flex"><Icon name="check" className="w-3 h-3 text-blue-500 -mr-1" /><Icon name="check" className="w-3 h-3 text-blue-500" /></span>;
        if (msg.status === 'delivered') return <span className="flex"><Icon name="check" className="w-3 h-3 text-gray-400 -mr-1" /><Icon name="check" className="w-3 h-3 text-gray-400" /></span>;
        if (msg.status === 'failed') return <Icon name="alert-circle" className="w-3 h-3 text-red-500" />;
        return <Icon name="check" className="w-3 h-3 text-gray-400" />; 
    };

    return (
        <div className={`flex w-full mb-2 ${isOutgoing ? 'justify-end' : 'justify-start'}`}>
            <div 
                className={`relative max-w-[85%] sm:max-w-[70%] rounded-xl shadow-sm text-sm group overflow-hidden border border-transparent
                ${isOutgoing ? 'bg-[#e0f2fe] rounded-tr-none border-blue-50' : 'bg-white rounded-tl-none border-gray-100'}
                `}
            >
                {/* --- GÃ–RSEL ALANI --- */}
                {isImage && (
                    <div className="p-1 cursor-pointer" onClick={() => onImageClick(mediaUrl)}>
                        <img 
                            src={mediaUrl} 
                            alt="Media" 
                            className="rounded-lg w-full h-auto max-h-[300px] object-cover bg-gray-100" 
                            loading="lazy"
                            onError={(e) => {e.target.style.display='none'}}
                        />
                    </div>
                )}

                {/* --- SES DOSYASI ALANI (Ã–ZEL Ä°STEK) --- */}
                {/* Type audio ise: Ä°kon ve tÄ±rnak iÃ§inde body metni */}
                {isAudio ? (
                    <div className="px-3 pt-3 pb-1 flex items-start gap-3">
                        <div className="mt-0.5 w-8 h-8 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 flex-shrink-0">
                            <Icon name="mic" className="w-4 h-4" />
                        </div>
                        <div className="flex flex-col">
                            {/* Metni tÄ±rnak iÃ§inde ve italik gÃ¶steriyoruz */}
                            <p className="text-gray-800 break-words whitespace-pre-wrap leading-relaxed italic">
                                "{msg.body}"
                            </p>
                            {/* Ä°steÄŸe baÄŸlÄ±: Ses dosyasÄ±nÄ± dinlemek iÃ§in link (gerekirse kaldÄ±rabilirsin) */}
                            {mediaUrl && (
                                <a href={mediaUrl} target="_blank" rel="noopener noreferrer" className="text-[10px] text-brand-500 font-medium mt-1 hover:underline">
                                    Ses KaydÄ±nÄ± AÃ§
                                </a>
                            )}
                        </div>
                    </div>
                ) : (
                    /* --- NORMAL METÄ°N ALANI --- */
                    /* Ses deÄŸilse ve metin varsa burasÄ± Ã§alÄ±ÅŸÄ±r */
                    msg.body && (msg.body !== '[GÃ¶rsel]' || !isImage) && (
                        <div className={`px-3 pt-2 ${isTimeOverlay ? 'pb-8' : 'pb-1'}`}>
                            <p className="text-gray-800 break-words whitespace-pre-wrap leading-relaxed">
                                {msg.body}
                            </p>
                        </div>
                    )
                )}
                
                {/* --- SAAT VE TÄ°K ALANI --- */}
                <div className={`flex items-center justify-end gap-1 select-none px-2 pb-1.5
                    ${isTimeOverlay 
                        ? 'absolute bottom-1 right-1 bg-black/30 rounded-full px-2 py-0.5 text-white backdrop-blur-sm' 
                        : 'text-gray-400 mt-0.5' 
                    }`}>
                    <span className={`text-[10px] min-w-[30px] text-right ${isTimeOverlay ? 'text-white/90' : ''}`}>
                        {new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </span>
                    {isOutgoing && (
                        <span className={isTimeOverlay ? 'text-white' : ''}>
                            {getStatusIcon()}
                        </span>
                    )}
                </div>
            </div>
        </div>
    );
}

        // --- UPDATED DATE SEPARATOR (NO STICKY) ---
        function DateSeparator({ date }) {
            const dateObj = new Date(date);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            let label = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            if (dateObj.toDateString() === today.toDateString()) label = "BugÃ¼n";
            else if (dateObj.toDateString() === yesterday.toDateString()) label = "DÃ¼n";

            return (
                <div className="flex justify-center my-6 relative z-0">
                    <span className="bg-gray-100 text-gray-500 text-xs font-medium px-3 py-1 rounded-full shadow-sm border border-gray-200">
                        {label}
                    </span>
                </div>
            );
        }

        function MessengerPage({ t, currentUser, uniqueUsers }) {
            const [chatList, setChatList] = useState([]);
            const [selectedChat, setSelectedChat] = useState(null);
            const [chatMessages, setChatMessages] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [inputMsg, setInputMsg] = useState('');
            const [isLoadingChats, setIsLoadingChats] = useState(true); 
            const [isLoadingMessages, setIsLoadingMessages] = useState(false);
            const [previewImage, setPreviewImage] = useState(null);
            const [selectedCategory, setSelectedCategory] = useState("All"); 
            const messagesEndRef = useRef(null);

            // GÃœNCELLENMÄ°Åž KATEGORÄ°LER (SayÄ±lar kaldÄ±rÄ±ldÄ± ve Ã§eviri eklendi)
            const categories = [
                { id: "All", label: t.catAll },
                { id: "Hot", label: t.catHot },
                { id: "Warm", label: t.catWarm },
                { id: "Cold", label: t.catCold },
                { id: "Other", label: t.catOther }
            ];

            const groupedMessages = useMemo(() => {
                const groups = {};
                if(!chatMessages) return groups;
                chatMessages.forEach(msg => {
                    const date = new Date(msg.created_at).toDateString();
                    if (!groups[date]) groups[date] = [];
                    groups[date].push(msg);
                });
                return groups;
            }, [chatMessages]);

            const loadActiveChats = useCallback(async (isBackgroundUpdate = false) => {
                if (!isBackgroundUpdate) setIsLoadingChats(true);
                
                const { data: chatsData, error: chatsError } = await supabase
                    .from(ACTIVE_CHATS_TABLE)
                    .select('*')
                    .order('last_interaction_at', { ascending: false });

                if (chatsError) {
                    console.error("Error loading chats:", chatsError);
                    if (!isBackgroundUpdate) setIsLoadingChats(false);
                    return;
                }

                const { data: leadsData, error: leadsError } = await supabase
                    .from(LEADS_TABLE_NAME)
                    .select('phone, user_name'); 

                if (leadsError) {
                    setChatList(chatsData); 
                    if (!isBackgroundUpdate) setIsLoadingChats(false);
                    return;
                }

                const phoneToUserMap = {};
                if (leadsData) {
                    leadsData.forEach(lead => {
                        if (lead.phone && lead.user_name) {
                            phoneToUserMap[lead.phone] = lead.user_name;
                        }
                    });
                }

                let enrichedChats = chatsData.map(chat => ({
                    ...chat,
                    user_name: phoneToUserMap[chat.lead_phone] || 'Unknown' 
                }));

                if (currentUser && currentUser.role !== 'admin') {
                    enrichedChats = enrichedChats.filter(c => c.user_name === currentUser.user_name);
                } 

                setChatList(enrichedChats);
                if (!isBackgroundUpdate) setIsLoadingChats(false);

            }, [currentUser]);

            useEffect(() => {
                loadActiveChats(false); 
                const interval = setInterval(() => loadActiveChats(true), 10000); 
                const channel = supabase
                    .channel('realtime_chats')
                    .on('postgres_changes', { event: '*', schema: 'public', table: ACTIVE_CHATS_TABLE }, () => {
                        loadActiveChats(true); 
                    })
                    .subscribe();

                return () => {
                    clearInterval(interval);
                    supabase.removeChannel(channel);
                };
            }, [loadActiveChats]);

            useEffect(() => {
                if (!selectedChat) return;

                const loadMessages = async () => {
                    setIsLoadingMessages(true);
                    const { data, error } = await supabase
                        .from(MESSAGES_TABLE)
                        .select('*')
                        .eq('lead_phone', selectedChat.lead_phone)
                        .order('created_at', { ascending: true });

                    if (!error && data) {
                        setChatMessages(data);
                    }
                    setIsLoadingMessages(false);
                };

                loadMessages();

                if (selectedChat.unread_count > 0) {
                    setChatList(prev => prev.map(c => c.id === selectedChat.id ? { ...c, unread_count: 0 } : c));
                    supabase
                        .from(ACTIVE_CHATS_TABLE)
                        .update({ unread_count: 0 })
                        .eq('id', selectedChat.id)
                        .then(({ error }) => {
                            if (error) console.error("Read status update error:", error);
                        });
                }

                const channel = supabase
                    .channel(`room_${selectedChat.lead_phone}`)
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: MESSAGES_TABLE, filter: `lead_phone=eq.${selectedChat.lead_phone}` }, (payload) => {
                        setChatMessages(prev => [...prev, payload.new]);
                    })
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: MESSAGES_TABLE, filter: `lead_phone=eq.${selectedChat.lead_phone}` }, (payload) => {
                        setChatMessages(prev => prev.map(msg => msg.id === payload.new.id ? payload.new : msg));
                    })
                    .subscribe();

                return () => {
                    supabase.removeChannel(channel);
                };
            }, [selectedChat]);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatMessages, selectedChat]);

            const handleSendMessage = async () => {
                if (!inputMsg.trim() || !selectedChat) return;

                const phone = selectedChat.lead_phone;
                const message = inputMsg;
                setInputMsg('');

                try {
                    const formData = new FormData();
                    formData.append('phone', phone);
                    formData.append('message', message);

                    await fetch(SEND_MESSAGE_WEBHOOK, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: formData
                    });
                } catch (error) {
                    console.error("Send error:", error);
                }
            };

            const handleToggleAI = async (e, chat) => {
                e.stopPropagation();
                const isAIActive = chat.ai_mode === 'active';
                const newMode = isAIActive ? 'manual' : 'active';
                
                setChatList(prev => prev.map(c => c.lead_phone === chat.lead_phone ? { ...c, ai_mode: newMode } : c));
                if (selectedChat?.lead_phone === chat.lead_phone) {
                    setSelectedChat(prev => ({ ...prev, ai_mode: newMode }));
                }

                await supabase.from(ACTIVE_CHATS_TABLE).update({ ai_mode: newMode }).eq('id', chat.id);

                try {
                    const formData = new FormData();
                    formData.append('phone', chat.lead_phone);
                    formData.append('action', newMode === 'active' ? 'enable' : 'disable');
                    await fetch(TOGGLE_AI_WEBHOOK, { method: 'POST', mode: 'no-cors', body: formData });
                } catch (e) { console.error(e); }
            };

            const filteredChats = chatList.filter(c => {
                const matchesSearch = (c.contact_name && c.contact_name.toLowerCase().includes(searchQuery.toLowerCase())) || 
                                      (c.lead_phone && c.lead_phone.includes(searchQuery));
                
                let matchesCategory = false;
                const score = c.ai_score || 0;

                if (selectedCategory === 'All') {
                    matchesCategory = true;
                } else if (selectedCategory === 'Hot') {
                    matchesCategory = score >= 70;
                } else if (selectedCategory === 'Warm') {
                    matchesCategory = score >= 50 && score <= 69;
                } else if (selectedCategory === 'Cold') {
                    matchesCategory = score >= 31 && score <= 49;
                } else if (selectedCategory === 'Other') {
                    matchesCategory = score <= 30;
                }

                return matchesSearch && matchesCategory;
            });

            const formatDateTime = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleString('tr-TR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            };

            return (
                <div className="flex w-full h-full bg-white border-t border-gray-200 animate-fade-in overflow-hidden">
                    <ImageViewer src={previewImage} onClose={() => setPreviewImage(null)} t={t} />

                    <div className={`${selectedChat ? 'hidden md:flex' : 'flex'} w-full md:w-[380px] bg-white border-r border-gray-200 flex-col flex-none z-20`}>
                        <div className="p-4 bg-white border-b border-gray-100 flex flex-col gap-4">
                            <div className="flex items-center justify-between">
                                <h2 className="text-xl font-bold text-gray-800 tracking-tight">{t.foldersTitle}</h2>
                                <div className="p-2 bg-gray-50 rounded-full text-gray-400">
                                    <Icon name="filter" className="w-4 h-4" />
                                </div>
                            </div>
                            
                            <div className="relative w-full">
                                <select 
                                    value={selectedCategory} 
                                    onChange={(e) => setSelectedCategory(e.target.value)} 
                                    className="w-full appearance-none bg-white border border-gray-300 text-gray-700 py-3 px-4 pr-8 rounded-xl leading-tight focus:outline-none focus:bg-white focus:border-brand-500 font-semibold shadow-sm transition-all cursor-pointer hover:border-brand-300"
                                >
                                    {categories.map(cat => (
                                        <option key={cat.id} value={cat.id}>{cat.label}</option>
                                    ))}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                    <Icon name="chevron-down" className="w-4 h-4" />
                                </div>
                            </div>

                            <div className="relative w-full">
                                <input 
                                    type="text" 
                                    placeholder={t.searchPlaceholder} 
                                    className="w-full pl-10 pr-4 py-2.5 bg-gray-50 border-transparent focus:bg-white focus:border-brand-300 focus:ring-4 focus:ring-brand-50/50 rounded-xl text-sm transition-all" 
                                    value={searchQuery} 
                                    onChange={(e) => setSearchQuery(e.target.value)} 
                                />
                                <div className="absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="search" className="w-4 h-4" /></div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scroll">
                            {isLoadingChats ? (
                                <div className="flex justify-center p-8"><div className="spinner w-6 h-6 border-2 border-brand-200 border-t-brand-500"></div></div>
                            ) : filteredChats.length === 0 ? (
                                <div className="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                                    <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3">
                                        <Icon name="inbox" className="w-8 h-8 text-gray-300" />
                                    </div>
                                    <p className="text-sm font-medium text-gray-500">Bu kategoride sohbet yok.</p>
                                </div>
                            ) : (
                                filteredChats.map(chat => (
                                    <div key={chat.lead_phone} onClick={() => setSelectedChat(chat)} className={`flex items-start gap-3 p-4 cursor-pointer hover:bg-gray-50 transition-all border-b border-gray-50 group relative ${selectedChat?.lead_phone === chat.lead_phone ? 'bg-brand-50 border-l-4 border-l-brand-500' : 'border-l-4 border-l-transparent'}`}>
                                            <div className="relative">
                                                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-brand-100 to-brand-200 flex items-center justify-center text-brand-700 font-bold text-lg shadow-sm">
                                                    {(chat.contact_name || chat.lead_phone).charAt(0).toUpperCase()}
                                                </div>
                                                {chat.ai_score > 0 && (
                                                    <div className={`absolute -top-1 -right-1 text-[9px] font-bold px-1.5 py-0.5 rounded-full border border-white shadow-sm text-white
                                                        ${chat.ai_score >= 70 ? 'bg-red-500' : chat.ai_score >= 50 ? 'bg-orange-400' : chat.ai_score >= 31 ? 'bg-blue-400' : 'bg-gray-400'}`}>
                                                        {chat.ai_score}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            <div className="flex-1 min-w-0 pt-0.5">
                                                <div className="flex justify-between items-start mb-1">
                                                    <h4 className={`font-bold truncate text-sm ${selectedChat?.lead_phone === chat.lead_phone ? 'text-brand-900' : 'text-gray-800'}`}>
                                                        {chat.contact_name || chat.lead_phone}
                                                    </h4>
                                                    <span className={`text-[10px] whitespace-nowrap ml-2 ${chat.unread_count > 0 ? 'text-brand-600 font-bold' : 'text-gray-400'}`}>
                                                        {formatDateTime(chat.last_interaction_at)}
                                                    </span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <p className={`text-xs truncate pr-2 ${chat.unread_count > 0 ? 'text-gray-900 font-medium' : 'text-gray-500'}`}>
                                                        {chat.last_msg_direction === 'outbound' && <span className="text-brand-500 mr-1">siz:</span>}
                                                        {chat.last_msg_preview || '...'}
                                                    </p>
                                                    {chat.unread_count > 0 && (
                                                        <span className="bg-brand-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center shadow-sm animate-pulse">
                                                            {chat.unread_count}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    <div className={`${!selectedChat ? 'hidden md:flex' : 'flex'} flex-1 flex-col relative min-w-0 bg-[#f0f9ff]`}>
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-0 overflow-hidden opacity-[0.03]">
                            <SmileZoneLogo />
                        </div>
                        <div className="absolute inset-0 chat-bg-pattern pointer-events-none z-0 mix-blend-multiply opacity-40"></div>
                        
                        {selectedChat ? (
                            <>
                                <div className="bg-white/90 backdrop-blur border-b border-gray-200 flex flex-col relative z-10 shadow-sm flex-none">
                                    <div className="h-16 flex items-center px-4 justify-between">
                                        <div className="flex items-center gap-3">
                                            <button onClick={() => setSelectedChat(null)} className="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-full"><Icon name="arrow-left" className="w-5 h-5" /></button>
                                            <div className="w-10 h-10 rounded-full bg-brand-100 flex items-center justify-center text-brand-600 font-bold text-sm shadow-inner border border-brand-200">
                                                {(selectedChat.contact_name || selectedChat.lead_phone).charAt(0).toUpperCase()}
                                            </div>
                                            <div className="flex flex-col cursor-pointer">
                                                <h3 className="font-bold text-gray-800 leading-tight text-sm flex items-center gap-2">
                                                    {selectedChat.contact_name || selectedChat.lead_phone}
                                                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold border
                                                        ${selectedChat.ai_score >= 70 ? 'bg-red-50 text-red-600 border-red-100' : 
                                                          selectedChat.ai_score >= 50 ? 'bg-orange-50 text-orange-600 border-orange-100' : 
                                                          selectedChat.ai_score >= 31 ? 'bg-blue-50 text-blue-600 border-blue-100' : 
                                                          'bg-gray-50 text-gray-500 border-gray-100'}`}>
                                                        Skor: {selectedChat.ai_score || 0}
                                                    </span>
                                                </h3>
                                                <p className="text-xs text-brand-500 font-medium">{selectedChat.lead_phone}</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <div onClick={(e) => handleToggleAI(e, selectedChat)} className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-bold cursor-pointer transition-all border shadow-sm ${selectedChat.ai_mode === 'active' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-50 text-gray-500 border-gray-200'}`}>
                                                <Icon name="bot" className="w-3.5 h-3.5" />
                                                {selectedChat.ai_mode === 'active' ? 'AI AUTO' : 'AI OFF'}
                                            </div>
                                            <button className="text-gray-400 hover:text-brand-600 hover:bg-brand-50 p-2 rounded-full transition-colors"><Icon name="more-vertical" className="w-5 h-5" /></button>
                                        </div>
                                    </div>
                                    
                                    {/* GÃœNCELLENMÄ°Åž Ã–ZET (SUMMARY) ALANI - ESTETÄ°K TASARIM */}
                                    {selectedChat.conversation_summary && (
                                        <div className="mx-4 mt-2 mb-2 p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl flex items-start gap-3 shadow-sm relative overflow-hidden">
                                            <div className="p-1.5 bg-white rounded-lg text-brand-600 shadow-sm flex-shrink-0 mt-0.5">
                                                <Icon name="sparkles" className="w-4 h-4" />
                                            </div>
                                            <div className="flex-1 z-10">
                                                <p className="text-[10px] uppercase font-bold text-brand-400 tracking-wider mb-0.5">Yapay Zeka Ã–zeti</p>
                                                <p className="text-xs text-gray-700 leading-relaxed font-medium">
                                                    {selectedChat.conversation_summary}
                                                </p>
                                            </div>
                                            <div className="absolute top-0 right-0 w-16 h-16 bg-white opacity-20 rounded-full -mr-6 -mt-6 pointer-events-none"></div>
                                        </div>
                                    )}
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-1 custom-scroll relative z-10">
                                    {isLoadingMessages ? (
                                        <div className="flex justify-center p-4"><div className="spinner w-8 h-8 border-2 border-brand-300 border-t-brand-600"></div></div>
                                    ) : (
                                        Object.keys(groupedMessages).map(date => (
                                            <React.Fragment key={date}>
                                                <DateSeparator date={date} />
                                                {groupedMessages[date].map((msg, index) => (
                                                    <MessageBubble 
                                                        key={msg.id || index} 
                                                        msg={msg} 
                                                        isOutgoing={msg.direction === 'outbound'} 
                                                        onImageClick={setPreviewImage} 
                                                    />
                                                ))}
                                            </React.Fragment>
                                        ))
                                    )}
                                    <div ref={messagesEndRef} className="h-4" />
                                </div>

                                <div className="p-4 relative z-20">
                                    {/* GÃœNCELLENMÄ°Åž MESAJ GÄ°RÄ°Åž ALANI - ORANTILI TASARIM */}
                                    <div className="bg-white rounded-[2rem] shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-100 flex items-center p-2 gap-2 transition-all duration-300 hover:shadow-[0_8px_30px_rgb(0,0,0,0.12)] min-h-[60px]">
                                        <button className="p-3 text-gray-400 hover:text-brand-600 hover:bg-brand-50 rounded-full transition-colors flex-shrink-0 h-12 w-12 flex items-center justify-center">
                                            <Icon name="plus" className="w-6 h-6" />
                                        </button>
                                        
                                        <div className="flex-1 flex items-center h-full px-2">
                                            <input 
                                                type="text" 
                                                className="w-full h-full py-3 border-none focus:ring-0 p-0 text-gray-800 placeholder-gray-400 bg-transparent text-sm font-medium" 
                                                placeholder={t.typeMessage} 
                                                value={inputMsg} 
                                                onChange={(e) => setInputMsg(e.target.value)}
                                                onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                                            />
                                        </div>

                                        <div className="flex items-center gap-1 pr-1">
                                            <button className="p-2.5 text-gray-400 hover:text-brand-500 transition-colors rounded-full hover:bg-gray-50 flex-shrink-0"><Icon name="smile" className="w-5 h-5" /></button>
                                            <button className="p-2.5 text-gray-400 hover:text-brand-500 transition-colors rounded-full hover:bg-gray-50 flex-shrink-0"><Icon name="camera" className="w-5 h-5" /></button>
                                            
                                            {inputMsg.trim() ? (
                                                <button onClick={handleSendMessage} className="ml-2 p-3 bg-brand-600 text-white rounded-full hover:bg-brand-700 transition-all active:scale-95 shadow-lg shadow-brand-500/30 flex items-center justify-center w-12 h-12 flex-shrink-0">
                                                    <Icon name="send" className="w-5 h-5 ml-0.5" />
                                                </button>
                                            ) : (
                                                <button className="ml-2 p-3 bg-gray-100 text-gray-400 rounded-full hover:bg-brand-50 hover:text-brand-500 transition-all flex items-center justify-center w-12 h-12 flex-shrink-0">
                                                    <Icon name="mic" className="w-5 h-5" />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                    <div className="text-center mt-2">
                                        <p className="text-[10px] text-gray-300 font-medium">Smile Zone Secured Chat</p>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex-1 flex flex-col items-center justify-center text-brand-300 relative z-10 select-none">
                                <div className="w-40 h-40 bg-brand-50 rounded-full flex items-center justify-center mb-6 opacity-80 shadow-inner">
                                    <Icon name="message-square" className="w-20 h-20 text-brand-200" />
                                </div>
                                <h3 className="text-2xl font-light text-brand-700 mb-2">Smile Zone Messenger</h3>
                                <p className="text-sm text-brand-400 max-w-xs text-center">GÃ¶rÃ¼ÅŸmeleri yÃ¶netmek iÃ§in soldan bir sohbet seÃ§in.</p>
                                <div className="mt-8 flex items-center gap-2 text-xs text-brand-300">
                                    <Icon name="lock" className="w-3 h-3" /> UÃ§tan uca ÅŸifreli (Demo)
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function App() {
            const [language, setLanguage] = useState('tr');
            const [currentUser, setCurrentUser] = useState(null);
            const [activeMenu, setActiveMenu] = useState('leads'); 
            const [viewState, setViewState] = useState('idle');
            const [currentSummary, setCurrentSummary] = useState(null);
            const [history, setHistory] = useState([]);
            const [isHistoryLoading, setIsHistoryLoading] = useState(true);
            const [selectedUser, setSelectedUser] = useState("");
            const [userName, setUserName] = useState('');
            const [campaignName, setCampaignName] = useState('');
            const [alert, setAlert] = useState(null);
            const [isSearching, setIsSearching] = useState(false);
            const [fileToDelete, setFileToDelete] = useState(null);
            const [isDeleting, setIsDeleting] = useState(false);

            const t = TRANSLATIONS[language];
            const uniqueUsers = useMemo(() => { const users = history.map(item => item.user_name || 'Anonymous'); return [...new Set(users)]; }, [history]);
            const isAppMode = activeMenu === 'messenger';

            useEffect(() => { fetchHistory(); }, []);
            const handleLogin = (user) => { setCurrentUser(user); setUserName(user.user_name); };
            const handleLogout = () => { setCurrentUser(null); setUserName(''); setCurrentSummary(null); setViewState('idle'); setCampaignName(''); setAlert(null); setFileToDelete(null); setActiveMenu('leads'); };
            const toggleLanguage = () => { setLanguage(prev => prev === 'tr' ? 'en' : 'tr'); };

            const handleDownloadTemplate = () => {
                try {
                    const sampleData = [{ "Full Name": "John Doe", "Phone Number": "905551234567", "Email": "john@example.com", "Note": "Interested in implant" }, { "Full Name": "Jane Smith", "Phone Number": "447700900000", "Email": "jane@example.com", "Note": "Veneers inquiry" }];
                    const ws = XLSX.utils.json_to_sheet(sampleData);
                    ws['!cols'] = [{wch: 20}, {wch: 15}, {wch: 25}, {wch: 30}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Leads Template");
                    XLSX.writeFile(wb, "SmileZone_Leads_Template.xlsx");
                    setAlert({type: 'success', message: t.templateDownloaded});
                } catch (error) { setAlert({type: 'error', message: t.templateError}); }
            };

            const fetchHistory = async () => {
                setIsHistoryLoading(true);
                try {
                    const { data, error } = await supabase.from(TABLE_NAME).select('*').order('created_at', { ascending: false });
                    if (error) throw error; if (data) setHistory(data);
                } catch (err) { setAlert({type: 'error', message: t.historyFetchError}); } finally { setIsHistoryLoading(false); }
            };

            const handleDeleteClick = (item) => { setFileToDelete(item); };
            const handleConfirmDelete = async () => {
                if (!fileToDelete) return;
                setIsDeleting(true);
                try {
                    await fetch(DELETE_WEBHOOK_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: fileToDelete.id, file_name: fileToDelete.file_name, user_name: fileToDelete.user_name }) });
                    await new Promise(r => setTimeout(r, 1500));
                    const { error } = await supabase.from(TABLE_NAME).delete().eq('id', fileToDelete.id);
                    if (error) throw error;
                    setAlert({type: 'success', message: t.msgDeleted});
                    fetchHistory(); 
                } catch (err) { setAlert({type: 'error', message: t.msgDeleteError}); } finally { setIsDeleting(false); setFileToDelete(null); }
            };

            const pollForRecord = async (fileName, uName) => {
                setIsSearching(true);
                const maxAttempts = 10;
                let attempts = 0;
                const check = async () => {
                    try {
                        const { data } = await supabase.from(TABLE_NAME).select('*').order('created_at', { ascending: false }).limit(5);
                        if (data && data.length > 0) {
                            const recentRecord = data.find(record => (new Date().getTime() - new Date(record.created_at).getTime()) < 60000);
                            if (recentRecord) return recentRecord;
                        }
                    } catch (e) { console.error(e); }
                    return null;
                };
                const loop = async () => {
                    const record = await check();
                    if (record) {
                        setCurrentSummary({ fileName: record.file_name, userName: record.user_name, campaignName: record.campaign_name || record['Campaign Name'], total_rows: record.total_rows, success_count: record.success_count, duplicate_count: record.duplicate_count, exist_count: record.exist_count || 0, error_count: record.error_count, status: 'Completed' });
                        setViewState('idle'); setCampaignName(''); fetchHistory(); setIsSearching(false);
                    } else {
                        attempts++;
                        if (attempts < maxAttempts) { setTimeout(loop, 2000); } else { setAlert({type: 'success', message: t.msgSentChecking}); fetchHistory(); setViewState('idle'); setIsSearching(false); }
                    }
                };
                loop();
            };

            const handleFileUpload = async (file) => {
                if (!userName.trim()) { setAlert({type: 'warning', message: t.errorNoUser}); document.getElementById('userNameInput')?.focus(); return; }
                setViewState('uploading'); setAlert(null); setCurrentSummary(null); 
                const formData = new FormData();
                formData.append('data', file, file.name); formData.append('User Name', userName); formData.append('File Name', file.name); formData.append('Campaign Name', campaignName);
                try {
                    await fetch(WEBHOOK_URL, { method: 'POST', mode: 'no-cors', credentials: 'omit', body: formData });
                    await new Promise(r => setTimeout(r, 2000));
                    await pollForRecord(file.name, userName);
                } catch (error) {
                    if (navigator.onLine) { setAlert({type: 'success', message: t.msgRequestChecking}); await pollForRecord(file.name, userName); } else { setAlert({type: 'error', message: t.msgNetworkError}); setViewState('idle'); }
                }
            };

            return (
                <div className="flex w-full h-full bg-[#F8FAFC]">
                    {!currentUser && <LoginOverlay onLogin={handleLogin} language={language} toggleLanguage={toggleLanguage} t={t} />}
                    <DeleteModal isOpen={!!fileToDelete} onClose={() => !isDeleting && setFileToDelete(null)} onConfirm={handleConfirmDelete} fileName={fileToDelete?.file_name} isDeleting={isDeleting} t={t} />
                    <Sidebar currentUser={currentUser} onLogout={handleLogout} t={t} activeMenu={activeMenu} setActiveMenu={setActiveMenu} />
                    
                    <main className={`flex-1 md:ml-64 transition-all duration-300 bg-[#F8FAFC] flex flex-col ${!currentUser ? 'blur-content' : ''} ${isAppMode ? 'h-full overflow-hidden' : 'min-h-screen p-6 md:p-10 overflow-y-auto'}`}>
                        {activeMenu !== 'messenger' && (
                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4 flex-none">
                                <div>
                                    {activeMenu === 'leads' && (
                                        <>
                                            <h1 className="text-3xl font-bold text-brand-600 tracking-tight">{t.pageTitle}</h1>
                                            <p className="text-sm text-brand-500 mt-1">{t.pageSubtitle}</p>
                                        </>
                                    )}
                                </div>
                                <div className="flex items-center gap-3">
                                    <button onClick={toggleLanguage} className="px-3 py-2 bg-white border border-gray-200 rounded-lg text-sm font-semibold text-gray-600 hover:text-brand-600 hover:border-brand-200 transition-all shadow-sm flex items-center gap-2"><Icon name="globe" className="w-4 h-4" />{language === 'tr' ? 'EN' : 'TR'}</button>
                                    {activeMenu === 'leads' && viewState === 'idle' && (
                                        <button onClick={handleDownloadTemplate} className="flex items-center gap-2 px-5 py-2.5 bg-white border border-gray-200 rounded-lg text-sm font-semibold text-brand-600 hover:bg-brand-50 hover:border-brand-200 transition-all shadow-sm"><Icon name="download" className="w-4 h-4" />{t.downloadTemplate}</button>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentUser && (
                            <>
                                {activeMenu === 'leads' && (
                                    <>
                                        <GlobalStats history={history} selectedUser={selectedUser} onUserChange={setSelectedUser} uniqueUsers={uniqueUsers} currentUser={currentUser} t={t} />
                                        {alert && (
                                            <div className={`mb-6 p-4 rounded-xl flex items-center gap-3 animate-fade-in shadow-sm ${alert.type === 'error' ? 'bg-red-50 text-red-700 border border-red-100' : 'bg-brand-50 text-brand-700 border border-brand-100'}`}>
                                                <div className="flex-shrink-0"><Icon name={alert.type === 'error' ? 'alert-circle' : 'check-circle-2'} className="w-5 h-5" /></div>
                                                <span className="text-sm font-medium">{alert.message}</span>
                                                <button onClick={() => setAlert(null)} className="ml-auto hover:opacity-75"><Icon name="x" className="w-4 h-4" /></button>
                                            </div>
                                        )}
                                        <div className="flex flex-col space-y-8 flex-1">
                                            {viewState === 'uploading' ? (
                                                <ProcessingState isSearching={isSearching} t={t} />
                                            ) : (
                                                <>
                                                    {currentSummary && <ReportSummary summary={currentSummary} t={t} />}
                                                    <UploadArea onFileSelect={handleFileUpload} uploading={false} userName={userName} setUserName={setUserName} campaignName={campaignName} setCampaignName={setCampaignName} onError={(msg) => setAlert({type: 'warning', message: msg})} currentUser={currentUser} t={t} />
                                                </>
                                            )}
                                            <div className="flex-1 min-h-[400px]">
                                                <HistoryTable history={history} selectedUser={selectedUser} isLoading={isHistoryLoading} onRefresh={fetchHistory} currentUser={currentUser} currentLang={language} t={t} onDelete={handleDeleteClick} />
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeMenu === 'sender' && (
                                    <BulkSenderPage t={t} setAlert={setAlert} currentUser={currentUser} uniqueUsers={uniqueUsers} />
                                )}

                                {activeMenu === 'messenger' && (
                                    <div className="flex-1 h-full w-full overflow-hidden">
                                        <MessengerPage t={t} currentUser={currentUser} uniqueUsers={uniqueUsers} />
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>